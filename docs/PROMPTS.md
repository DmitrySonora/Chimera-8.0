# Руководство по конфигурации системных промптов и режимов общения

**Файлы:** 

- config/prompts.py
- config/prompts_modulation.py

---

## Параметры генерации

Параметры автоматически применяются при определении режима в UserSessionActor.

`*_PARAMS` - словарь параметров для DeepSeek:

- `temperature` - креативность ответов (0.0-2.0)
- `top_p` - nucleus sampling параметр (0.0-1.0)
- `max_tokens` - максимальная длина ответа
- `frequency_penalty` - штраф за повторения
- `presence_penalty` - штраф за упоминание тем

---

## Управление системными промптами

`PROMPT_CONFIG` - настройки системного промпта:

- `system_prompt_interval` - включать промпт каждое N сообщение
- `enable_periodic_prompt` - включить периодичность
- `prompt_strategy` - стратегия: "always", "periodic", "adaptive"
- `use_json_mode` - использовать JSON формат ответов
- `json_fallback_enabled` - автоматический fallback при ошибке JSON
- `cache_hit_threshold` - ???
- `adaptive_check_interval` - ???
- `log_prompt_usage` - логировать использование промптов в консоль (по умолчанию: True)
- `log_prompt_preview_length` - количество символов промпта для показа в логах (по умолчанию: 100)

#### Настройка режимных промптов

`MODE_PROMPT_CONFIG` - управление построением промптов для режимов:

- `use_mode_modifiers` - использовать ли модификаторы режимов (по умолчанию: True)
- `combine_with_base` - комбинировать базовый промпт с модификатором (по умолчанию: True)
- `modifier_separator` - разделитель между базой и модификатором (по умолчанию: "\n\n")

#### Инструкции для структурированных ответов

`JSON_VALIDATION_CONFIG` - настройки валидации JSON-ответов:

- `strict_mode` - требовать все опциональные поля (по умолчанию: False)
- `log_validation_errors` - логировать ошибки валидации (по умолчанию: True)
- `validation_timeout_ms` - таймаут валидации в миллисекундах (по умолчанию: 10)
- `max_validation_errors` - максимум ошибок в одном логе (по умолчанию: 5)

`JSON_SCHEMA_INSTRUCTIONS` - инструкции для структурированных ответов по режимам:

- `talk` - схема с emotional_tone и engagement_level
- `expert` - схема с confidence, sources и assumptions
- `creative` - схема с style_markers и metaphors

---

## Логирование

`GENERATION_PARAMS_LOG_CONFIG` - настройки логирования параметров генерации:

- `log_parameters_usage` - сохранять ли использованные параметры в Event Store (по умолчанию: True)
- `log_response_length` - включать ли длину ответа в события (по умолчанию: True)
- `debug_mode_selection` - выводить ли подробную отладку при выборе режима (по умолчанию: False)

При включенном `log_parameters_usage` система создает события `GenerationParametersUsedEvent` для каждой генерации, содержащие:

- Использованный режим (talk/expert/creative/base)
- Все параметры генерации (temperature, top_p, max_tokens и др.)
- Длину сгенерированного ответа (если включен `log_response_length`)
- ID пользователя и временную метку

Это позволяет анализировать эффективность разных параметров и оптимизировать генерацию.

---

## Настройки модулирующих промптов

`PERSONALITY_INJECTIONS_ENABLED` - главный переключатель системы инъекций (по умолчанию: True). Позволяет полностью отключить добавление модуляций личности к промптам. Рекомендация: отключать только для A/B тестирования или отладки

`INJECTION_CONFIG` - словарь с дополнительными настройками системы:
- `enabled` - дублирующий флаг включения (по умолчанию: True)
- `max_traits_per_injection` - максимум черт в одной инъекции (по умолчанию: 3)
- `cache_last_profile` - кэшировать последний профиль пользователя (по умолчанию: True)
- `random_fallback_weights` - веса для random генерации [low, medium, high] (по умолчанию: [0.25, 0.5, 0.25])

`PERSONALITY_INJECTION_LOW_THRESHOLD` - нижний порог интенсивности черты (по умолчанию: 0.4). Значения черт ниже этого порога считаются "низкими". Рекомендация: 0.3-0.4 для более выраженных низких проявлений

`PERSONALITY_INJECTION_HIGH_THRESHOLD` - верхний порог интенсивности черты (по умолчанию: 0.7). Значения черт выше этого порога считаются "высокими". Рекомендация: 0.65-0.75 для баланса между средними и высокими проявлениями

`PERSONALITY_INJECTION_TRAITS_COUNT` - количество черт личности в одной инъекции (по умолчанию: 3). Определяет сколько доминирующих черт будет использовано для создания модуляции. Рекомендация: 2-4 черты для оптимального баланса между разнообразием и связностью

`PERSONALITY_INJECTION_HISTORY_SIZE` - размер истории для предотвращения повторений (по умолчанию: 3). Последние N использованных модуляций не будут повторяться для каждой черты. Рекомендация: 3-5 для вариативности без исчерпания вариантов

`PERSONALITY_INJECTION_RANDOM_WEIGHTS` - веса выбора уровней при random генерации (по умолчанию: [0.25, 0.5, 0.25]). Определяет вероятность выбора low/medium/high уровней при отсутствии данных о личности. Рекомендация: больший вес на medium (0.5) для естественности

`PERSONALITY_INJECTION_DEFAULT_TRAIT_VALUE` - значение черты по умолчанию (по умолчанию: 0.5). Используется когда конкретная черта отсутствует в профиле пользователя. Рекомендация: 0.5 для нейтрального проявления

`PERSONALITY_INJECTION_LOG_PREVIEW_LENGTH` - длина превью инъекции в INFO логах (по умолчанию: 150). Определяет сколько символов инъекции показывать в основных логах. Рекомендация: 60-150 для информативности без засорения

`PERSONALITY_INJECTION_DEBUG_PREVIEW_LENGTH` - длина превью модуляций в DEBUG логах (по умолчанию: 150). Определяет сколько символов каждой модуляции показывать при отладке. Рекомендация: 30-60 для компактного отображения выбранных вариантов

